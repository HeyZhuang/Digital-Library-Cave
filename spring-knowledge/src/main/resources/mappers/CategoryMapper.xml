<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itzixi.mapper.CategoryMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.itzixi.entity.Category">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="description" property="description" jdbcType="VARCHAR"/>
        <result column="parent_id" property="parentId" jdbcType="BIGINT"/>
        <result column="sort_order" property="sortOrder" jdbcType="INTEGER"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
        <result column="parent_name" property="parentName" jdbcType="VARCHAR"/>
        <result column="article_count" property="articleCount" jdbcType="BIGINT"/>
    </resultMap>

    <!-- 基础列 -->
    <sql id="Base_Column_List">
        id, name, description, parent_id, sort_order, created_at, updated_at
    </sql>

    <!-- 查询所有分类（包含文章数量） -->
    <select id="selectCategoriesWithArticleCount" resultMap="BaseResultMap">
        SELECT 
            c.id, c.name, c.description, c.parent_id, c.sort_order, 
            c.created_at, c.updated_at,
            pc.name AS parent_name,
            COALESCE(ac.article_count, 0) AS article_count
        FROM category c
        LEFT JOIN category pc ON c.parent_id = pc.id
        LEFT JOIN (
            SELECT category_id, COUNT(*) AS article_count 
            FROM article 
            WHERE status = 1 
            GROUP BY category_id
        ) ac ON c.id = ac.category_id
        ORDER BY c.sort_order ASC, c.created_at ASC
    </select>

    <!-- 根据父分类ID查询子分类 -->
    <select id="selectByParentId" resultMap="BaseResultMap">
        SELECT 
            c.id, c.name, c.description, c.parent_id, c.sort_order, 
            c.created_at, c.updated_at,
            COALESCE(ac.article_count, 0) AS article_count
        FROM category c
        LEFT JOIN (
            SELECT category_id, COUNT(*) AS article_count 
            FROM article 
            WHERE status = 1 
            GROUP BY category_id
        ) ac ON c.id = ac.category_id
        WHERE c.parent_id = #{parentId}
        ORDER BY c.sort_order ASC, c.created_at ASC
    </select>

    <!-- 查询根分类（父分类为空的分类） -->
    <select id="selectRootCategories" resultMap="BaseResultMap">
        SELECT 
            c.id, c.name, c.description, c.parent_id, c.sort_order, 
            c.created_at, c.updated_at,
            COALESCE(ac.article_count, 0) AS article_count
        FROM category c
        LEFT JOIN (
            SELECT category_id, COUNT(*) AS article_count 
            FROM article 
            WHERE status = 1 
            GROUP BY category_id
        ) ac ON c.id = ac.category_id
        WHERE c.parent_id IS NULL
        ORDER BY c.sort_order ASC, c.created_at ASC
    </select>

</mapper> 