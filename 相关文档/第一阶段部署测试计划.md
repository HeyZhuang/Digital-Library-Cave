# 第一阶段部署测试计划

## 📋 部署概述

**目标**: 部署第一阶段优化并验证效果  
**预期结果**: 支持100+并发用户，响应时间 < 200ms  
**测试时间**: 预计2-3小时  

## 🚀 部署步骤

### 1. 数据库优化部署

#### 1.1 执行数据库索引脚本
```bash
# 连接到MySQL数据库
mysql -h 140.143.155.164 -u deepseek_doctor -p deepseek_doctor

# 执行优化脚本
source /path/to/high_concurrency_optimization.sql
```

#### 1.2 验证索引创建
```sql
-- 检查索引是否创建成功
SHOW INDEX FROM sys_user;
SHOW INDEX FROM article;
SHOW INDEX FROM comment;

-- 检查视图是否创建成功
SHOW TABLES LIKE 'v_%';

-- 检查存储过程是否创建成功
SHOW PROCEDURE STATUS WHERE Db = 'deepseek_doctor';
```

### 2. Redis服务部署

#### 2.1 检查Redis服务状态
```bash
# 检查Redis是否运行
redis-cli -h 140.143.155.164 ping

# 检查Redis连接
redis-cli -h 140.143.155.164 info
```

#### 2.2 测试Redis连接
```bash
# 测试基本操作
redis-cli -h 140.143.155.164
> SET test "hello"
> GET test
> DEL test
```

### 3. 应用部署

#### 3.1 构建应用
```bash
# 进入项目目录
cd spring-knowledge

# 清理并重新构建
mvn clean package -DskipTests

# 检查生成的jar文件
ls -la target/deepseek-doctor.jar
```

#### 3.2 部署应用
```bash
# 停止现有应用（如果有）
pkill -f deepseek-doctor

# 备份现有jar文件
cp deepseek-doctor.jar deepseek-doctor.jar.backup

# 部署新版本
cp target/deepseek-doctor.jar ./

# 启动应用
nohup java -jar deepseek-doctor.jar --spring.profiles.active=prod > app.log 2>&1 &

# 检查应用状态
tail -f app.log
```

#### 3.3 验证应用启动
```bash
# 检查应用是否正常启动
curl -X GET http://140.143.155.164:8181/api/health

# 检查Redis连接
curl -X GET http://140.143.155.164:8181/api/cache/test
```

## 🧪 性能测试

### 1. 基础功能测试

#### 1.1 健康检查测试
```bash
# 测试健康检查接口
curl -X GET http://140.143.155.164:8181/api/health

# 预期结果: 返回200状态码
```

#### 1.2 文章列表测试
```bash
# 测试文章列表接口
curl -X GET "http://140.143.155.164:8181/api/articles?page=1&size=10"

# 预期结果: 返回文章列表数据
```

#### 1.3 用户登录测试
```bash
# 测试用户登录接口
curl -X POST http://140.143.155.164:8181/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test123"}'

# 预期结果: 返回JWT token
```

### 2. 压力测试

#### 2.1 安装Apache Bench
```bash
# Ubuntu/Debian
sudo apt-get install apache2-utils

# CentOS/RHEL
sudo yum install httpd-tools

# Windows (使用PowerShell)
# 下载ab.exe或使用其他工具
```

#### 2.2 基础压力测试
```bash
# 文章列表压力测试
ab -n 1000 -c 50 http://140.143.155.164:8181/api/articles

# 预期结果:
# - 平均响应时间 < 200ms
# - 错误率 < 1%
# - 吞吐量 > 500 req/s
```

#### 2.3 并发用户测试
```bash
# 逐步增加并发用户数
ab -n 1000 -c 10 http://140.143.155.164:8181/api/articles
ab -n 1000 -c 50 http://140.143.155.164:8181/api/articles
ab -n 1000 -c 100 http://140.143.155.164:8181/api/articles
ab -n 1000 -c 150 http://140.143.155.164:8181/api/articles
```

#### 2.4 登录压力测试
```bash
# 创建测试数据文件
echo '{"username":"test","password":"test123"}' > login.json

# 登录压力测试
ab -n 500 -c 50 -p login.json -T application/json http://140.143.155.164:8181/api/auth/login
```

### 3. 缓存效果测试

#### 3.1 缓存命中率测试
```bash
# 第一次请求（缓存未命中）
time curl -X GET "http://140.143.155.164:8181/api/articles/1"

# 第二次请求（缓存命中）
time curl -X GET "http://140.143.155.164:8181/api/articles/1"

# 预期结果: 第二次请求响应时间明显更快
```

#### 3.2 Redis缓存验证
```bash
# 检查Redis中的缓存数据
redis-cli -h 140.143.155.164
> KEYS *
> GET "article::1"
> TTL "article::1"
```

### 4. 数据库性能测试

#### 4.1 查询性能测试
```sql
-- 测试文章列表查询性能
EXPLAIN FORMAT=JSON
SELECT a.*, u.nickname AS author_name, c.name AS category_name
FROM article a
LEFT JOIN sys_user u ON a.author_id = u.id
LEFT JOIN category c ON a.category_id = c.id
WHERE a.status = 1
ORDER BY a.is_top DESC, a.created_at DESC
LIMIT 10;

-- 预期结果: 使用索引，查询时间 < 50ms
```

#### 4.2 连接池监控
```sql
-- 查看当前连接数
SHOW STATUS LIKE 'Threads_connected';

-- 查看最大连接数
SHOW VARIABLES LIKE 'max_connections';

-- 预期结果: 连接数 < 最大连接数的70%
```

## 📊 性能指标监控

### 1. 应用性能指标

#### 1.1 响应时间监控
```bash
# 监控应用响应时间
watch -n 1 'curl -w "@curl-format.txt" -o /dev/null -s http://140.143.155.164:8181/api/articles'
```

#### 1.2 内存使用监控
```bash
# 监控JVM内存使用
jstat -gc <pid> 1000

# 预期结果: 内存使用率 < 80%
```

### 2. 数据库性能指标

#### 2.1 慢查询监控
```sql
-- 启用慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;

-- 查看慢查询
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;
```

#### 2.2 连接池状态
```sql
-- 查看连接池状态
SHOW STATUS LIKE 'Threads_connected';
SHOW STATUS LIKE 'Threads_running';
SHOW STATUS LIKE 'Threads_created';
```

### 3. Redis性能指标

#### 3.1 Redis状态监控
```bash
# 查看Redis状态
redis-cli -h 140.143.155.164 info

# 查看内存使用
redis-cli -h 140.143.155.164 info memory

# 查看连接数
redis-cli -h 140.143.155.164 info clients
```

#### 3.2 缓存命中率
```bash
# 查看缓存统计
redis-cli -h 140.143.155.164 info stats

# 预期结果: 命中率 > 80%
```

## 🔍 问题排查

### 1. 常见问题及解决方案

#### 1.1 应用启动失败
```bash
# 检查日志
tail -f app.log

# 常见问题:
# - 数据库连接失败: 检查数据库配置
# - Redis连接失败: 检查Redis服务状态
# - 端口占用: 检查端口8181是否被占用
```

#### 1.2 性能不达标
```bash
# 检查数据库索引
SHOW INDEX FROM article;

# 检查Redis缓存
redis-cli -h 140.143.155.164 KEYS *

# 检查JVM参数
jps -l
jinfo <pid>
```

#### 1.3 内存泄漏
```bash
# 生成堆转储
jmap -dump:format=b,file=heap.hprof <pid>

# 分析堆转储
jhat heap.hprof
```

### 2. 性能调优

#### 2.1 数据库调优
```sql
-- 优化查询
EXPLAIN SELECT * FROM article WHERE status = 1;

-- 添加缺失索引
CREATE INDEX idx_missing ON table_name(column_name);
```

#### 2.2 应用调优
```bash
# 调整JVM参数
java -Xms2g -Xmx4g -XX:+UseG1GC -jar deepseek-doctor.jar

# 调整连接池参数
# 在application-prod.yml中调整hikari配置
```

## 📈 测试报告模板

### 测试结果记录
```
测试时间: 2025-01-08
测试环境: 生产环境
测试工具: Apache Bench

基础功能测试:
- 健康检查: ✅ 通过
- 文章列表: ✅ 通过  
- 用户登录: ✅ 通过

压力测试结果:
- 并发用户数: 100
- 平均响应时间: 150ms
- 95%响应时间: 300ms
- 错误率: 0.1%
- 吞吐量: 650 req/s

缓存效果:
- 缓存命中率: 85%
- 缓存响应时间: 20ms
- 数据库响应时间: 120ms

数据库性能:
- 连接池使用率: 45%
- 慢查询数量: 0
- 索引使用率: 95%
```

## 🎯 成功标准

### 必须达到的指标
- [ ] 应用正常启动
- [ ] 所有基础功能正常
- [ ] 支持100+并发用户
- [ ] 平均响应时间 < 200ms
- [ ] 错误率 < 1%
- [ ] 缓存命中率 > 80%

### 可选优化指标
- [ ] 支持150+并发用户
- [ ] 平均响应时间 < 150ms
- [ ] 缓存命中率 > 90%
- [ ] 数据库连接使用率 < 60%

## 🚨 回滚计划

如果测试结果不达标，执行以下回滚步骤：

### 1. 应用回滚
```bash
# 停止新版本
pkill -f deepseek-doctor

# 恢复旧版本
cp deepseek-doctor.jar.backup deepseek-doctor.jar

# 启动旧版本
nohup java -jar deepseek-doctor.jar --spring.profiles.active=prod > app.log 2>&1 &
```

### 2. 数据库回滚
```sql
-- 删除新增索引（如果需要）
DROP INDEX idx_article_hot ON article;
DROP INDEX idx_user_login ON sys_user;

-- 删除新增视图
DROP VIEW IF EXISTS v_hot_articles;
DROP VIEW IF EXISTS v_latest_articles;
```

### 3. 配置回滚
```bash
# 恢复原始配置文件
cp application-prod.yml.backup application-prod.yml
```

## 📝 总结

完成部署和测试后，记录以下信息：

1. **测试结果**: 记录所有测试数据和结果
2. **性能提升**: 对比优化前后的性能指标
3. **问题记录**: 记录遇到的问题和解决方案
4. **优化建议**: 提出进一步的优化建议

如果测试成功，可以开始第二阶段优化；如果存在问题，需要先解决后再继续。 