# 第一阶段部署检查清单

## 📋 部署前准备

### ✅ 环境检查
- [ ] Java 21 已安装并配置
- [ ] Maven 已安装并配置
- [ ] MySQL 数据库可访问
- [ ] Redis 服务已启动
- [ ] 网络连接正常

### ✅ 文件检查
- [ ] `pom.xml` 包含Redis依赖
- [ ] `application-prod.yml` 配置已更新
- [ ] `RedisConfig.java` 已创建
- [ ] `CacheService.java` 已创建
- [ ] `high_concurrency_optimization.sql` 已准备

## 🚀 部署步骤

### 1. 数据库优化
- [ ] 连接到MySQL数据库
- [ ] 执行索引优化脚本
- [ ] 验证索引创建成功
- [ ] 检查视图创建成功
- [ ] 验证存储过程创建成功

### 2. Redis配置
- [ ] 检查Redis服务状态
- [ ] 测试Redis连接
- [ ] 验证Redis配置正确

### 3. 应用部署
- [ ] 备份现有应用
- [ ] 构建新版本应用
- [ ] 停止现有应用
- [ ] 部署新版本应用
- [ ] 启动新应用
- [ ] 验证应用启动成功

### 4. 功能测试
- [ ] 健康检查接口测试
- [ ] 文章列表接口测试
- [ ] 用户登录接口测试
- [ ] 缓存功能测试

### 5. 性能测试
- [ ] 基础压力测试
- [ ] 并发用户测试
- [ ] 缓存效果测试
- [ ] 响应时间测试

## 📊 性能指标检查

### 必须达标的指标
- [ ] 应用正常启动
- [ ] 所有基础功能正常
- [ ] 支持100+并发用户
- [ ] 平均响应时间 < 200ms
- [ ] 错误率 < 1%
- [ ] 缓存命中率 > 80%

### 可选优化指标
- [ ] 支持150+并发用户
- [ ] 平均响应时间 < 150ms
- [ ] 缓存命中率 > 90%
- [ ] 数据库连接使用率 < 60%

## 🔧 快速部署命令

### Windows PowerShell
```powershell
# 1. 执行部署脚本
.\deploy-stage1.ps1

# 2. 执行快速测试
.\quick-test.ps1

# 3. 执行数据库索引脚本
mysql -h 140.143.155.164 -u deepseek_doctor -p deepseek_doctor < high_concurrency_optimization.sql
```

### Linux/Mac
```bash
# 1. 执行部署脚本
chmod +x deploy-stage1.sh
./deploy-stage1.sh

# 2. 执行快速测试
chmod +x quick-test.ps1
./quick-test.ps1

# 3. 执行数据库索引脚本
mysql -h 140.143.155.164 -u deepseek_doctor -p deepseek_doctor < high_concurrency_optimization.sql
```

## 📈 监控命令

### 应用监控
```bash
# 查看应用状态
ps aux | grep deepseek-doctor

# 查看端口监听
netstat -tuln | grep 8181

# 查看应用日志
tail -f app.log

# 查看JVM状态
jps -l
jstat -gc <pid>
```

### 数据库监控
```sql
-- 查看连接数
SHOW STATUS LIKE 'Threads_connected';

-- 查看慢查询
SHOW VARIABLES LIKE 'slow_query_log';

-- 查看索引使用情况
SHOW INDEX FROM article;
```

### Redis监控
```bash
# 查看Redis状态
redis-cli -h 140.143.155.164 info

# 查看缓存数据
redis-cli -h 140.143.155.164 KEYS *

# 查看内存使用
redis-cli -h 140.143.155.164 info memory
```

## 🧪 测试命令

### 基础功能测试
```bash
# 健康检查
curl -X GET http://140.143.155.164:8181/api/health

# 文章列表
curl -X GET "http://140.143.155.164:8181/api/articles?page=1&size=10"

# 用户登录
curl -X POST http://140.143.155.164:8181/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test123"}'
```

### 性能测试
```bash
# 基础压力测试
ab -n 1000 -c 50 http://140.143.155.164:8181/api/articles

# 高并发测试
ab -n 1000 -c 100 http://140.143.155.164:8181/api/articles

# 缓存效果测试
time curl -X GET "http://140.143.155.164:8181/api/articles/1"
time curl -X GET "http://140.143.155.164:8181/api/articles/1"
```

## 🚨 问题排查

### 常见问题及解决方案

#### 1. 应用启动失败
```bash
# 检查日志
tail -f app.log

# 常见问题:
# - 数据库连接失败: 检查数据库配置
# - Redis连接失败: 检查Redis服务状态
# - 端口占用: 检查端口8181是否被占用
```

#### 2. 性能不达标
```bash
# 检查数据库索引
SHOW INDEX FROM article;

# 检查Redis缓存
redis-cli -h 140.143.155.164 KEYS *

# 检查JVM参数
jps -l
jinfo <pid>
```

#### 3. 内存泄漏
```bash
# 生成堆转储
jmap -dump:format=b,file=heap.hprof <pid>

# 分析堆转储
jhat heap.hprof
```

## 📝 部署报告模板

### 部署结果记录
```
部署时间: 2025-01-08
部署环境: 生产环境
部署状态: 成功/失败

优化内容:
1. 数据库连接池优化 ✅
2. 数据库索引优化 ✅
3. Redis缓存配置 ✅

测试结果:
- 应用启动: ✅ 成功
- 健康检查: ✅ 通过
- 基础功能: ✅ 正常
- 性能测试: ✅ 通过

性能指标:
- 并发用户数: 100+
- 平均响应时间: 150ms
- 错误率: 0.1%
- 缓存命中率: 85%

问题记录:
- 问题1: 描述及解决方案
- 问题2: 描述及解决方案

下一步计划:
1. 开始第二阶段优化
2. 持续监控性能
3. 根据实际使用情况调整
```

## 🎯 成功标准

### 部署成功标准
- [ ] 应用正常启动并运行
- [ ] 所有基础功能正常工作
- [ ] 性能指标达到预期
- [ ] 缓存功能正常工作
- [ ] 数据库连接正常

### 测试成功标准
- [ ] 支持100+并发用户
- [ ] 平均响应时间 < 200ms
- [ ] 错误率 < 1%
- [ ] 缓存命中率 > 80%
- [ ] 系统稳定性良好

## 📋 后续步骤

### 如果部署成功
1. 开始第二阶段优化
2. 持续监控系统性能
3. 根据实际使用情况调整配置
4. 准备第三阶段优化

### 如果部署失败
1. 查看错误日志
2. 根据问题排查指南解决问题
3. 重新执行部署步骤
4. 确保所有问题解决后再继续

## 🔄 回滚计划

### 应用回滚
```bash
# 停止新版本
pkill -f deepseek-doctor

# 恢复旧版本
cp deepseek-doctor.jar.backup deepseek-doctor.jar

# 启动旧版本
nohup java -jar deepseek-doctor.jar --spring.profiles.active=prod > app.log 2>&1 &
```

### 数据库回滚
```sql
-- 删除新增索引（如果需要）
DROP INDEX idx_article_hot ON article;
DROP INDEX idx_user_login ON sys_user;

-- 删除新增视图
DROP VIEW IF EXISTS v_hot_articles;
DROP VIEW IF EXISTS v_latest_articles;
```

### 配置回滚
```bash
# 恢复原始配置文件
cp application-prod.yml.backup application-prod.yml
```

---

**注意**: 请按照此清单逐步执行，确保每个步骤都正确完成。如果遇到问题，请参考问题排查部分或联系技术支持。 